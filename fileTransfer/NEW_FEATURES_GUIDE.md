# 新功能使用指南

## 🎉 新增功能概览

### 1. 📋 IP历史记录功能

#### 功能特点
- **自动记录**：连接成功后自动保存IP地址到历史记录
- **设备关联**：自动读取远程设备ID并关联IP地址
- **智能建议**：支持历史IP地址快速选择
- **使用统计**：记录每个IP的使用次数和最后使用时间
- **持久化存储**：历史记录保存在本地JSON文件中

#### 使用方法
1. **查看历史记录**：点击主机地址输入框右侧的 📋 按钮
2. **选择历史IP**：在弹出窗口中双击或选择后点击"选择"按钮
3. **清除历史记录**：点击 🗑 按钮可清空所有历史记录
4. **自动加载**：程序启动时自动加载最后使用的IP地址

#### 数据格式
```json
{
  "ip_history": [
    {
      "ip": "192.168.1.100",
      "device_id": "M1220401L000189",
      "first_used": "2024-12-17T10:30:00",
      "last_used": "2024-12-17T15:45:00",
      "use_count": 5
    }
  ],
  "device_history": {
    "M1220401L000189": {
      "device_id": "M1220401L000189",
      "ip_list": ["192.168.1.100", "192.168.1.101"],
      "first_seen": "2024-12-17T10:30:00",
      "last_seen": "2024-12-17T15:45:00"
    }
  }
}
```

### 2. 🎨 文件类型颜色显示

#### 支持的文件类型和颜色
- **📁 目录** - 蓝色 (#3b82f6)
- **⚙️ 可执行文件** - 绿色 (#10b981)
- **🔗 符号链接** - 紫色 (#8b5cf6)
- **🖼️ 图片文件** - 橙色 (#f59e0b)
- **📄 文档文件** - 灰色 (#6b7280)
- **📦 压缩文件** - 红色 (#dc2626)
- **⚙️ 配置文件** - 青色 (#0891b2)
- **📜 脚本文件** - 翠绿色 (#059669)
- **📄 普通文件** - 深灰色 (#374151)

#### 文件类型识别规则
```python
# 图片文件
['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg']

# 文档文件
['.txt', '.doc', '.docx', '.pdf', '.md']

# 压缩文件
['.zip', '.tar', '.gz', '.bz2', '.rar', '.7z']

# 配置文件
['.conf', '.cfg', '.ini', '.yaml', '.yml', '.json']

# 脚本文件
['.sh', '.py', '.pl', '.rb', '.js']
```

### 3. 🚦 连接状态颜色指示

#### 状态指示器
- **🔴 未连接** - 红色圆点 + 灰色文字
- **🟢 已连接** - 绿色圆点 + 绿色文字
- **🔴 连接失败** - 红色圆点 + 红色文字

#### 状态信息显示
- 未连接：显示"未连接"
- 连接成功：显示"已连接 (IP地址)"，文字为绿色
- 连接失败：显示"连接失败"，文字为红色

### 4. 🔧 设备ID自动读取

#### 功能说明
- 连接成功后自动读取远程设备的屏幕ID
- 从 `/customer/screenId.ini` 文件读取 `deviceId` 配置项
- 支持文件不存在或配置项为空的情况
- 设备ID与IP地址关联保存

#### 配置文件格式
```ini
[screen]
deviceId=M1220401L000189
```

#### 异常处理
- 文件不存在：记录警告，不影响连接
- 配置项为空：记录警告，仅保存IP不关联设备
- 读取失败：记录错误，继续正常连接流程

## 🛠 技术实现

### IP历史管理器 (`ip_history_manager.py`)
- 使用JSON格式持久化存储
- 支持IP地址验证和去重
- 提供丰富的查询和管理接口
- 线程安全的文件操作

### 文件类型识别
- 基于文件权限判断可执行文件和目录
- 结合文件扩展名进行类型分类
- 支持自定义颜色和图标配置

### 异步设备ID读取
- 使用telnet客户端异步读取配置文件
- 错误处理确保不影响主要连接流程
- 支持多种配置文件格式

## 📝 使用建议

### IP历史记录
1. **定期清理**：建议定期清理无用的历史记录
2. **备份重要记录**：可手动备份 `ip_history.json` 文件
3. **设备管理**：利用设备ID功能管理多个设备的IP变化

### 文件浏览
1. **颜色识别**：通过颜色快速识别文件类型
2. **权限注意**：绿色文件表示可执行，注意安全性
3. **链接跟踪**：紫色链接文件需要注意指向的实际位置

### 连接管理
1. **状态监控**：通过颜色指示器快速了解连接状态
2. **错误诊断**：红色状态提示连接问题，检查网络和配置
3. **设备识别**：利用设备ID功能区分不同设备

## 🔍 故障排除

### IP历史记录问题
- **历史记录不显示**：检查 `ip_history.json` 文件权限
- **设备ID读取失败**：确认远程设备配置文件存在
- **历史记录损坏**：删除 `ip_history.json` 文件重新开始

### 文件颜色显示问题
- **颜色不显示**：检查终端是否支持颜色输出
- **文件类型错误**：可能是权限或扩展名识别问题
- **显示异常**：尝试刷新目录或重新连接

### 连接状态问题
- **状态不更新**：检查网络连接和设备状态
- **颜色异常**：可能是主题或显示设置问题
- **设备ID为空**：检查远程设备配置文件内容

## 📈 性能优化

- IP历史记录限制在50条以内，自动清理旧记录
- 文件类型识别基于本地算法，不增加网络开销
- 设备ID读取采用异步方式，不阻塞主界面
- 颜色配置缓存，提高显示性能 