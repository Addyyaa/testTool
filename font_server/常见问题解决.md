# 字体服务器常见问题解决

## 1. TypeError: 'dict_keys' object is not subscriptable

### 问题描述
```python
font_ttf = response.json()["fonts"]
key = font_ttf.keys()
font_style = font_ttf[key]  # 错误：dict_keys不能作为索引
```

### 错误原因
在Python 3中，`dict.keys()`返回的是`dict_keys`对象，不是列表，不能直接用作索引。

### 解决方案
```python
# ❌ 错误写法
key = font_ttf.keys()
font_style = font_ttf[key]

# ✅ 正确写法1：转换为列表
font_names = list(font_ttf.keys())
selected_font = font_names[0]
font_info = font_ttf[selected_font]

# ✅ 正确写法2：直接遍历
for font_name in font_ttf.keys():
    font_info = font_ttf[font_name]
    break  # 获取第一个

# ✅ 正确写法3：使用next()
font_name = next(iter(font_ttf.keys()))
font_info = font_ttf[font_name]
```

## 2. 客户端使用误区

### 问题描述
客户端获取字体的所有字符（3000+个），导致不必要的数据传输。

### 错误做法
```python
# ❌ 不需要获取所有字符
chars_response = client.get_font_characters(font_name)
characters = chars_response.get('characters', [])  # 收到3000+个字符
```

### 正确做法
```python
# ✅ 只发送需要的文字内容
text_to_display = "收银台 金额:¥123.45"
response = requests.post(f'{server_url}/api/font/subset/{font_name}',
    json={'text': text_to_display, 'format': 'ttf'})
```

## 3. 服务器连接问题

### 问题描述
```
❌ 无法连接服务器
```

### 解决步骤
1. 检查服务器是否启动
   ```bash
   python start_font_server.py
   ```

2. 检查端口是否被占用
   ```bash
   netstat -an | findstr 8889
   ```

3. 检查防火墙设置

4. 验证服务器地址
   ```python
   server_url = "http://localhost:8889"  # 本地测试
   # server_url = "http://192.168.1.100:8889"  # 远程服务器
   ```

## 4. 字体文件问题

### 问题描述
```
❌ 没有找到字体文件
```

### 解决方案
1. 检查字体目录结构
   ```
   fonts/
   ├── english/
   │   ├── Arial.ttf
   │   └── Times.ttf
   └── chinese/
       └── NotoSansSC.ttf
   ```

2. 复制系统字体文件
   ```bash
   # Windows
   copy "C:\Windows\Fonts\arial.ttf" "fonts\english\Arial.ttf"
   
   # Linux/Mac
   cp /System/Library/Fonts/Arial.ttf fonts/english/Arial.ttf
   ```

3. 检查文件权限
   ```bash
   ls -la fonts/
   ```

## 5. 字体子集创建失败

### 问题描述
```
❌ 创建字体子集失败: 400 Client Error
```

### 可能原因及解决方案

1. **请求格式错误**
   ```python
   # ✅ 正确的请求格式
   {
       "text": "你好世界",
       "format": "ttf"
   }
   ```

2. **字体不支持字符**
   - 检查文字中的字符是否在字体中存在
   - 使用包含相应字符的字体

3. **超时问题**
   ```python
   response = requests.post(url, json=data, timeout=30)
   ```

## 6. 性能优化建议

### 缓存利用
- 相同字符集的请求会命中缓存
- 合理组织文字内容，提高缓存命中率

### 格式选择
- TTF：兼容性最好
- WOFF2：压缩比最高
- 根据需求选择合适格式

### 批量处理
```python
# ✅ 推荐：一次包含所有需要的字符
text = "收银台 金额:¥123.45 找零:¥6.55 谢谢惠顾"

# ❌ 不推荐：多次小批量请求
# text1 = "收银台"
# text2 = "金额"
# text3 = "找零"
```

## 7. 调试技巧

### 启用详细日志
```bash
python font_server.py --log-level DEBUG
```

### 查看日志文件
```bash
tail -f font_server.log
```

### 使用健康检查
```python
response = requests.get("http://localhost:8889/health")
print(response.json())
```

### 获取服务器统计
```python
response = requests.get("http://localhost:8889/api/stats")
print(response.json())
``` 